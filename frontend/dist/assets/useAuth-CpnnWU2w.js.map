{"version":3,"file":"useAuth-CpnnWU2w.js","sources":["../../src/hooks/useAuth.ts"],"sourcesContent":["/**\r\n * =============================================================================\r\n * HOOK DE AUTENTICACIÓN\r\n * =============================================================================\r\n */\r\n\r\nimport { useState, useCallback } from 'react';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { supabase } from '@/lib/supabase';\r\nimport { useAuthStore } from '@/stores/authStore';\r\nimport { useToast } from '@/stores/uiStore';\r\nimport { AppError, AuthenticationError } from '@/lib/errors';\r\n\r\ninterface UseAuthReturn {\r\n  // State\r\n  isLoading: boolean;\r\n  error: AppError | null;\r\n  \r\n  // Actions\r\n  signInWithEmail: (email: string) => Promise<boolean>;\r\n  signInWithPhone: (phone: string) => Promise<boolean>;\r\n  verifyOtp: (token: string, type: 'email' | 'phone', contact: string) => Promise<boolean>;\r\n  signOut: () => Promise<void>;\r\n  clearError: () => void;\r\n}\r\n\r\nexport function useAuth(): UseAuthReturn {\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [error, setError] = useState<AppError | null>(null);\r\n  const navigate = useNavigate();\r\n  const { logout } = useAuthStore();\r\n  const toast = useToast();\r\n\r\n  const clearError = useCallback(() => setError(null), []);\r\n\r\n  /**\r\n   * Enviar magic link por email\r\n   */\r\n  const signInWithEmail = useCallback(async (email: string): Promise<boolean> => {\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const { error: authError } = await supabase.auth.signInWithOtp({\r\n        email,\r\n        options: {\r\n          emailRedirectTo: `${window.location.origin}/auth/callback`,\r\n        },\r\n      });\r\n\r\n      if (authError) {\r\n        throw new AuthenticationError(authError.message);\r\n      }\r\n\r\n      toast.success('Email enviado', 'Revisá tu casilla de correo');\r\n      return true;\r\n    } catch (err) {\r\n      const appError = err instanceof AppError \r\n        ? err \r\n        : new AuthenticationError('No se pudo enviar el email');\r\n      setError(appError);\r\n      toast.error(appError.userTitle, appError.userMessage);\r\n      return false;\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [toast]);\r\n\r\n  /**\r\n   * Enviar OTP por SMS\r\n   */\r\n  const signInWithPhone = useCallback(async (phone: string): Promise<boolean> => {\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      // Formatear número con código de país\r\n      const formattedPhone = phone.startsWith('+') ? phone : `+54${phone}`;\r\n\r\n      const { error: authError } = await supabase.auth.signInWithOtp({\r\n        phone: formattedPhone,\r\n      });\r\n\r\n      if (authError) {\r\n        throw new AuthenticationError(authError.message);\r\n      }\r\n\r\n      toast.success('Código enviado', 'Revisá los SMS de tu teléfono');\r\n      return true;\r\n    } catch (err) {\r\n      const appError = err instanceof AppError \r\n        ? err \r\n        : new AuthenticationError('No se pudo enviar el SMS');\r\n      setError(appError);\r\n      toast.error(appError.userTitle, appError.userMessage);\r\n      return false;\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [toast]);\r\n\r\n  /**\r\n   * Verificar código OTP\r\n   */\r\n  const verifyOtp = useCallback(async (\r\n    token: string,\r\n    type: 'email' | 'phone',\r\n    contact: string\r\n  ): Promise<boolean> => {\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const verifyOptions = type === 'email'\r\n        ? { email: contact, token, type: 'email' as const }\r\n        : { phone: contact.startsWith('+') ? contact : `+54${contact}`, token, type: 'sms' as const };\r\n\r\n      const { error: authError } = await supabase.auth.verifyOtp(verifyOptions);\r\n\r\n      if (authError) {\r\n        throw new AuthenticationError(\r\n          authError.message.includes('expired')\r\n            ? 'El código expiró. Solicitá uno nuevo.'\r\n            : 'Código incorrecto. Verificá e intentá de nuevo.'\r\n        );\r\n      }\r\n\r\n      toast.success('¡Bienvenido!', 'Sesión iniciada correctamente');\r\n      navigate('/dashboard');\r\n      return true;\r\n    } catch (err) {\r\n      const appError = err instanceof AppError \r\n        ? err \r\n        : new AuthenticationError('No se pudo verificar el código');\r\n      setError(appError);\r\n      toast.error(appError.userTitle, appError.userMessage);\r\n      return false;\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [navigate, toast]);\r\n\r\n  /**\r\n   * Cerrar sesión\r\n   */\r\n  const signOut = useCallback(async (): Promise<void> => {\r\n    setIsLoading(true);\r\n\r\n    try {\r\n      await supabase.auth.signOut();\r\n      logout();\r\n      navigate('/login');\r\n      toast.info('Sesión cerrada', 'Hasta pronto');\r\n    } catch (err) {\r\n      console.error('Sign out error:', err);\r\n      // Forzar logout local aunque falle el servidor\r\n      logout();\r\n      navigate('/login');\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [logout, navigate, toast]);\r\n\r\n  return {\r\n    isLoading,\r\n    error,\r\n    signInWithEmail,\r\n    signInWithPhone,\r\n    verifyOtp,\r\n    signOut,\r\n    clearError,\r\n  };\r\n}\r\n\r\n"],"names":["useAuth","isLoading","setIsLoading","useState","error","setError","navigate","useNavigate","logout","useAuthStore","toast","useToast","clearError","useCallback","signInWithEmail","email","authError","supabase","AuthenticationError","err","appError","AppError","signInWithPhone","phone","formattedPhone","verifyOtp","token","type","contact","verifyOptions","signOut"],"mappings":"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"}